<#@ template language="C#" #>
<#@ output extension=".cs" #>
<#
    var generatedHeader = CommonGeneratorUtils.GetGeneratedHeader();
    var workerTypeList = GetWorkerTypes();
#>
<#= generatedHeader #>

using Improbable.Gdk.BuildSystem;
using Improbable.Gdk.BuildSystem.Configuration;
using Improbable.Gdk.Tools;
using UnityEditor;
using UnityEngine;

namespace Improbable
{
    internal static class BuildWorkerMenu
    {
        private const string LocalMenu = "Build for local";
        private const string CloudMenu = "Build for cloud";

        private static readonly string[] AllWorkers =
        {
<# foreach (var workerType in workerTypeList) { #>
            "<#= workerType #>",
<# } #>
        };

<#
for (var i = 0; i < workerTypeList.Count; i++) {
var workerType = workerTypeList[i];
#>
        [MenuItem(EditorConfig.ParentMenu + "/" + LocalMenu + "/<#= workerType #>", false, EditorConfig.MenuOffset + <#=i #>)]
        public static void BuildLocal<#= workerType #>()
        {
            MenuBuild(BuildEnvironment.Local, "<#= workerType #>");
        }

        [MenuItem(EditorConfig.ParentMenu + "/" + CloudMenu + "/<#= workerType #>", false, EditorConfig.MenuOffset + <#= i #>)]
        public static void BuildCloud<#= workerType #>()
        {
            MenuBuild(BuildEnvironment.Cloud, "<#= workerType #>");
        }

<# } #>

        [MenuItem(EditorConfig.ParentMenu + "/" + LocalMenu + "/All workers", false, EditorConfig.MenuOffset + <#= workerTypeList.Count #>)]
        public static void BuildLocalAll()
        {
            MenuBuild(BuildEnvironment.Local, AllWorkers);
        }

        [MenuItem(EditorConfig.ParentMenu + "/" + CloudMenu + "/All workers", false, EditorConfig.MenuOffset + <#= workerTypeList.Count #>)]
        public static void BuildCloudAll()
        {
            MenuBuild(BuildEnvironment.Cloud, AllWorkers);
        }

        [MenuItem(EditorConfig.ParentMenu + "/Clean all workers", false, EditorConfig.MenuOffset + <#= workerTypeList.Count #>)]
        public static void Clean()
        {
            WorkerBuilder.Clean();
            Debug.Log("Clean completed");
        }

        private static bool ValidateWorkersCanBuildForEnvironment(BuildEnvironment environment, string[] workerTypes)
        {
            var canInitiateBuild = true;
            var spatialOSBuildConfiguration = SpatialOSBuildConfiguration.GetInstance();

            foreach (var workerType in workerTypes)
            {
                try
                {
                    WorkerBuilder.AssertWorkerCanBuildForEnvironment(workerType, environment);
                }
                catch (System.Exception e)
                {
                    canInitiateBuild = false;

                    Debug.LogException(e, spatialOSBuildConfiguration);
                }
            }

            return canInitiateBuild;
        }

        private static void MenuBuild(BuildEnvironment environment, params string[] workerTypes)
        {
            // Delaying build by a frame to ensure the editor has re-rendered the UI to avoid odd glitches.
            EditorApplication.delayCall += () =>
            {
                if (!ValidateWorkersCanBuildForEnvironment(environment, workerTypes))
                {
                    DisplayBuildFailureDialog();

                    return;
                }

                try
                {
                    LocalLaunch.BuildConfig();

                    foreach (var workerType in workerTypes)
                    {
                        WorkerBuilder.BuildWorkerForEnvironment(workerType, environment);
                    }

                    Debug.LogFormat("Completed build for {0} target", environment);
                }
                catch (System.Exception)
                {
                    DisplayBuildFailureDialog();

                    throw;
                }
            };
        }

        private static void DisplayBuildFailureDialog()
        {
            EditorUtility.DisplayDialog("Build Failed",
                "Build failed. Please see the Unity Console Window for information.",
                "OK");
        }

        [MenuItem(EditorConfig.ParentMenu + "/Validate Build Support", false, EditorConfig.MenuOffset + <#= workerTypeList.Count + 1 #>)]
        private static void ValidateBuildSupport()
        {
            var validationsPassed = true;

            if (!ValidateWorkersCanBuildForEnvironment(BuildEnvironment.Local, AllWorkers))
            {
                validationsPassed = false;
            }

            if (!ValidateWorkersCanBuildForEnvironment(BuildEnvironment.Cloud, AllWorkers))
            {
                validationsPassed = false;
            }

            EditorUtility.DisplayDialog("Build Support Validation",
                validationsPassed
                    ? "Build support validation confirms your Unity Editor installation has all necessary components."
                    : "Build support validation failed. Please see the Unity Console Window for information.",
                "OK");

            Debug.Log("Diagnosis complete.");
        }
    }
}
