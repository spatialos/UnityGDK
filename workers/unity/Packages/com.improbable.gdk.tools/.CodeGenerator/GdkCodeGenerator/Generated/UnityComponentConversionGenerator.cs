//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.42000
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

namespace Improbable.Gdk.CodeGenerator {
    using System;
    using Improbable.CodeGeneration.Jobs;
    
    
    public partial class UnityComponentConversionGenerator : UnityComponentConversionGeneratorBase {
        
        public virtual string TransformText() {
            this.GenerationEnvironment = null;
            
            #line 3 "Templates\UnityComponentConversionGenerator.tt"

    var fieldDetailsList = GetFieldDetailsList();
    var componentDetails = GetComponentDetails();
    var generatedHeader = CommonGeneratorUtils.GetGeneratedHeader();
    var commandDetailsList = GetCommandDetailsList();
    var eventDetailsList = GetEventDetailsList();

            
            #line default
            #line hidden
            
            #line 10 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( generatedHeader ));
            
            #line default
            #line hidden
            
            #line 10 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"

using System;
using System.Collections.Generic;
using System.Linq;
using UnityEngine;
using Unity.Mathematics;
using Unity.Entities;
using Improbable.Worker.Core;
using Improbable.Gdk.Core;
using Improbable.Gdk.Core.CodegenAdapters;
using Improbable.Gdk.Core.Commands;

namespace ");
            
            #line default
            #line hidden
            
            #line 23 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 23 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n{\r\n    public partial class ");
            
            #line default
            #line hidden
            
            #line 25 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 25 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n    {\r\n        public class DispatcherHandler : ComponentDispatcherHandler\r\n   " +
                    "     {\r\n            public override uint ComponentId => ");
            
            #line default
            #line hidden
            
            #line 29 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentId ));
            
            #line default
            #line hidden
            
            #line 29 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(";\r\n\r\n            private readonly EntityManager entityManager;\r\n\r\n            pri" +
                    "vate const string LoggerName = \"");
            
            #line default
            #line hidden
            
            #line 33 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 33 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".DispatcherHandler\";\r\n\r\n");
            
            #line default
            #line hidden
            
            #line 35 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 36 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("            private CommandStorages.");
            
            #line default
            #line hidden
            
            #line 36 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName));
            
            #line default
            #line hidden
            
            #line 36 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(" ");
            
            #line default
            #line hidden
            
            #line 36 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseName ));
            
            #line default
            #line hidden
            
            #line 36 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Storage;\r\n");
            
            #line default
            #line hidden
            
            #line 37 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 38 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"
            public DispatcherHandler(MutableView mutableView, global::Unity.Entities.World world) : base(mutableView, world)
            {
                entityManager = mutableView.EntityManager;
                var bookkeepingSystem = world.GetOrCreateManager<CommandRequestTrackerSystem>();
");
            
            #line default
            #line hidden
            
            #line 43 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 44 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                ");
            
            #line default
            #line hidden
            
            #line 44 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseName ));
            
            #line default
            #line hidden
            
            #line 44 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Storage = bookkeepingSystem.GetCommandStorageForType<CommandStorages.");
            
            #line default
            #line hidden
            
            #line 44 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName));
            
            #line default
            #line hidden
            
            #line 44 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">();\r\n");
            
            #line default
            #line hidden
            
            #line 45 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 46 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("            }\r\n\r\n            public override void Dispose()\r\n            {\r\n");
            
            #line default
            #line hidden
            
            #line 50 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var fieldDetails in fieldDetailsList) { 
            
            #line default
            #line hidden
            
            #line 51 "Templates\UnityComponentConversionGenerator.tt"
 if (!fieldDetails.IsBlittable) { 
            
            #line default
            #line hidden
            
            #line 52 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                ");
            
            #line default
            #line hidden
            
            #line 52 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 52 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 52 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( fieldDetails.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 52 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Provider.CleanDataInWorld(World);\r\n");
            
            #line default
            #line hidden
            
            #line 53 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 54 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 55 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetails in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 56 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                ");
            
            #line default
            #line hidden
            
            #line 56 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 56 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 56 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 56 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Provider.CleanDataInWorld(World);\r\n");
            
            #line default
            #line hidden
            
            #line 57 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 58 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"            }

            public override void OnAddComponent(AddComponentOp op)
            {
                if (!IsValidEntityId(op.EntityId, ""AddComponentOp"", out var entity))
                {
                    return;
                }

                var data = global::");
            
            #line default
            #line hidden
            
            #line 67 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 67 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 67 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 67 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Serialization.Deserialize(op.Data.SchemaData.Value.GetFields(), World);\r\n       " +
                    "         data.DirtyBit = false;\r\n                entityManager.AddComponentData(" +
                    "entity, data);\r\n                entityManager.AddComponentData(entity, new NotAu" +
                    "thoritative<");
            
            #line default
            #line hidden
            
            #line 70 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 70 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">());\r\n\r\n                if (entityManager.HasComponent<ComponentRemoved<");
            
            #line default
            #line hidden
            
            #line 72 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 72 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">>(entity))\r\n                {\r\n                    entityManager.RemoveComponent" +
                    "<ComponentRemoved<");
            
            #line default
            #line hidden
            
            #line 74 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 74 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">>(entity);\r\n                }\r\n                else if (!entityManager.HasCompon" +
                    "ent<ComponentAdded<");
            
            #line default
            #line hidden
            
            #line 76 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 76 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">>(entity))\r\n                {\r\n                    entityManager.AddComponentDat" +
                    "a(entity, new ComponentAdded<");
            
            #line default
            #line hidden
            
            #line 78 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 78 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@">());
                }
                else
                {
                    LogDispatcher.HandleLog(LogType.Error, new LogEvent(ReceivedDuplicateComponentAdded)
                        .WithField(LoggingUtils.LoggerName, LoggerName)
                        .WithField(LoggingUtils.EntityId, op.EntityId.Id)
                        .WithField(""Component"", """);
            
            #line default
            #line hidden
            
            #line 85 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 85 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@""")
                    );
                }
            }

            public override void OnRemoveComponent(RemoveComponentOp op)
            {
                if (!IsValidEntityId(op.EntityId, ""RemoveComponentOp"", out var entity))
                {
                    return;
                }
");
            
            #line default
            #line hidden
            
            #line 96 "Templates\UnityComponentConversionGenerator.tt"
 if (!componentDetails.IsBlittable) { 
            
            #line default
            #line hidden
            
            #line 97 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                var data = entityManager.GetComponentData<");
            
            #line default
            #line hidden
            
            #line 98 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 98 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entity);\r\n");
            
            #line default
            #line hidden
            
            #line 99 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var fieldDetails in fieldDetailsList) { 
            
            #line default
            #line hidden
            
            #line 100 "Templates\UnityComponentConversionGenerator.tt"
 if (!fieldDetails.IsBlittable) { 
            
            #line default
            #line hidden
            
            #line 101 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                ");
            
            #line default
            #line hidden
            
            #line 101 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 101 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 101 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( fieldDetails.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 101 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Provider.Free(data.");
            
            #line default
            #line hidden
            
            #line 101 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( fieldDetails.CamelCaseName ));
            
            #line default
            #line hidden
            
            #line 101 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Handle);\r\n");
            
            #line default
            #line hidden
            
            #line 102 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 103 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 104 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 105 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                entityManager.RemoveComponent<");
            
            #line default
            #line hidden
            
            #line 106 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 106 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entity);\r\n\r\n                if (entityManager.HasComponent<ComponentAdded<");
            
            #line default
            #line hidden
            
            #line 108 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 108 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">>(entity))\r\n                {\r\n                    entityManager.RemoveComponent" +
                    "<ComponentAdded<");
            
            #line default
            #line hidden
            
            #line 110 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 110 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">>(entity);\r\n                }\r\n                else if (!entityManager.HasCompon" +
                    "ent<ComponentRemoved<");
            
            #line default
            #line hidden
            
            #line 112 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 112 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">>(entity))\r\n                {\r\n                    entityManager.AddComponentDat" +
                    "a(entity, new ComponentRemoved<");
            
            #line default
            #line hidden
            
            #line 114 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 114 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@">());
                }
                else
                {
                    LogDispatcher.HandleLog(LogType.Error, new LogEvent(ReceivedDuplicateComponentRemoved)
                        .WithField(LoggingUtils.LoggerName, LoggerName)
                        .WithField(LoggingUtils.EntityId, op.EntityId.Id)
                        .WithField(""Component"", """);
            
            #line default
            #line hidden
            
            #line 121 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 121 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@""")
                    );
                }
            }

            public override void OnComponentUpdate(ComponentUpdateOp op)
            {
                if (!IsValidEntityId(op.EntityId, ""OnComponentUpdate"", out var entity))
                {
                    return;
                }

                var data = entityManager.GetComponentData<");
            
            #line default
            #line hidden
            
            #line 133 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 133 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entity);\r\n\r\n                var update = global::");
            
            #line default
            #line hidden
            
            #line 135 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 135 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 135 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 135 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Serialization.GetAndApplyUpdate(op.Update.SchemaData.Value.GetFields(), ref data" +
                    ");\r\n\r\n                if (entityManager.HasComponent<");
            
            #line default
            #line hidden
            
            #line 137 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 137 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReceivedUpdates>(entity))\r\n                {\r\n                    var updates = " +
                    "entityManager.GetComponentData<");
            
            #line default
            #line hidden
            
            #line 139 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 139 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReceivedUpdates>(entity);\r\n                    updates.Updates.Add(update);\r\n   " +
                    "             }\r\n                else\r\n                {\r\n                    var" +
                    " updates = new ");
            
            #line default
            #line hidden
            
            #line 144 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 144 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReceivedUpdates\r\n                    {\r\n                        handle = Referen" +
                    "ceTypeProviders.UpdatesProvider.Allocate(World)\r\n                    };\r\n       " +
                    "             ReferenceTypeProviders.UpdatesProvider.Set(updates.handle, new List" +
                    "<");
            
            #line default
            #line hidden
            
            #line 148 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 148 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Update>());\r\n                    entityManager.AddComponentData(entity, updates)" +
                    ";\r\n                }\r\n\r\n");
            
            #line default
            #line hidden
            
            #line 152 "Templates\UnityComponentConversionGenerator.tt"
 if (eventDetailsList.Count > 0) { 
            
            #line default
            #line hidden
            
            #line 153 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                var eventsObject = op.Update.SchemaData.Value.GetEvents();\r\n");
            
            #line default
            #line hidden
            
            #line 154 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetails in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 155 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                {\r\n                    var eventCount = eventsObject.GetObjectCou" +
                    "nt(");
            
            #line default
            #line hidden
            
            #line 156 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventIndex ));
            
            #line default
            #line hidden
            
            #line 156 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(");\r\n                    if (eventCount > 0)\r\n                    {\r\n             " +
                    "           // Create component to hold received events\r\n                        " +
                    "ReceivedEvents.");
            
            #line default
            #line hidden
            
            #line 160 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 160 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(" eventsReceived;\r\n                        List<");
            
            #line default
            #line hidden
            
            #line 161 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.FullyQualifiedPayloadTypeName ));
            
            #line default
            #line hidden
            
            #line 161 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("> eventList;\r\n                        if (!entityManager.HasComponent<ReceivedEve" +
                    "nts.");
            
            #line default
            #line hidden
            
            #line 162 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 162 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entity))\r\n                        {\r\n                            eventsReceived" +
                    " = new ReceivedEvents.");
            
            #line default
            #line hidden
            
            #line 164 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 164 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("() {\r\n                                handle = ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 165 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 165 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Provider.Allocate(World)\r\n                            };\r\n                       " +
                    "     eventList = new List<");
            
            #line default
            #line hidden
            
            #line 167 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.FullyQualifiedPayloadTypeName ));
            
            #line default
            #line hidden
            
            #line 167 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">((int) eventCount);\r\n                            ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 168 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 168 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"Provider.Set(eventsReceived.handle, eventList);
                            entityManager.AddComponentData(entity, eventsReceived);
                        }
                        else
                        {
                            eventsReceived = entityManager.GetComponentData<ReceivedEvents.");
            
            #line default
            #line hidden
            
            #line 173 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 173 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@">(entity);
                            eventList = eventsReceived.Events;
                        }

                        // Deserialize events onto component
                        for (var i = 0; i < eventCount; i++)
                        {
                            var e = ");
            
            #line default
            #line hidden
            
            #line 180 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.FullyQualifiedPayloadTypeName ));
            
            #line default
            #line hidden
            
            #line 180 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Serialization.Deserialize(eventsObject.GetObject(");
            
            #line default
            #line hidden
            
            #line 180 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventIndex ));
            
            #line default
            #line hidden
            
            #line 180 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("));\r\n                            eventList.Add(e);\r\n                        }\r\n  " +
                    "                  }\r\n                }\r\n\r\n");
            
            #line default
            #line hidden
            
            #line 186 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 187 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 188 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"                data.DirtyBit = false;
                entityManager.SetComponentData(entity, data);
            }

            public override void OnAuthorityChange(AuthorityChangeOp op)
            {
                if (!IsValidEntityId(op.EntityId, ""AuthorityChangeOp"", out var entity))
                {
                    return;
                }

                ApplyAuthorityChange(entity, op.Authority, op.EntityId);
            }

            public override void OnCommandRequest(CommandRequestOp op)
            {
                if (!IsValidEntityId(op.EntityId, ""CommandRequestOp"", out var entity))
                {
                    return;
                }

                var commandIndex = op.Request.SchemaData.Value.GetCommandIndex();
                switch (commandIndex)
                {
");
            
            #line default
            #line hidden
            
            #line 212 "Templates\UnityComponentConversionGenerator.tt"
 foreach(var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 213 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                    case ");
            
            #line default
            #line hidden
            
            #line 213 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandIndex ));
            
            #line default
            #line hidden
            
            #line 213 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(":\r\n                        On");
            
            #line default
            #line hidden
            
            #line 214 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 214 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Request(op);\r\n                        break;\r\n");
            
            #line default
            #line hidden
            
            #line 216 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 217 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"                    default:
                        LogDispatcher.HandleLog(LogType.Error, new LogEvent(CommandIndexNotFound)
                            .WithField(LoggingUtils.LoggerName, LoggerName)
                            .WithField(LoggingUtils.EntityId, op.EntityId.Id)
                            .WithField(""CommandIndex"", commandIndex)
                            .WithField(""Component"", """);
            
            #line default
            #line hidden
            
            #line 222 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 222 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@""")
                        );
                        break;
                }
            }

            public override void OnCommandResponse(CommandResponseOp op)
            {
                var commandIndex = op.Response.SchemaData.Value.GetCommandIndex();
                switch (commandIndex)
                {
");
            
            #line default
            #line hidden
            
            #line 233 "Templates\UnityComponentConversionGenerator.tt"
 foreach(var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 234 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                    case ");
            
            #line default
            #line hidden
            
            #line 234 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandIndex ));
            
            #line default
            #line hidden
            
            #line 234 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(":\r\n                        On");
            
            #line default
            #line hidden
            
            #line 235 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 235 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Response(op);\r\n                        break;\r\n");
            
            #line default
            #line hidden
            
            #line 237 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 238 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"                    default:
                        LogDispatcher.HandleLog(LogType.Error, new LogEvent(CommandIndexNotFound)
                            .WithField(LoggingUtils.LoggerName, LoggerName)
                            .WithField(LoggingUtils.EntityId, op.EntityId.Id)
                            .WithField(""CommandIndex"", commandIndex)
                            .WithField(""Component"", """);
            
            #line default
            #line hidden
            
            #line 243 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 243 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\")\r\n                        );\r\n                        break;\r\n                }" +
                    "\r\n            }\r\n\r\n            public override void AddCommandComponents(Unity.E" +
                    "ntities.Entity entity)\r\n            {\r\n");
            
            #line default
            #line hidden
            
            #line 251 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 252 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                {\r\n                    var commandSender = new ");
            
            #line default
            #line hidden
            
            #line 253 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 253 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 253 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 253 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".CommandSenders.");
            
            #line default
            #line hidden
            
            #line 253 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 253 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("();\r\n                    commandSender.CommandListHandle = ");
            
            #line default
            #line hidden
            
            #line 254 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 254 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 254 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 254 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 254 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 254 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("SenderProvider.Allocate(World);\r\n                    commandSender.RequestsToSend" +
                    " = new List<");
            
            #line default
            #line hidden
            
            #line 255 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 255 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 255 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 255 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 255 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 255 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Request>();\r\n\r\n                    entityManager.AddComponentData(entity, comman" +
                    "dSender);\r\n\r\n                    var commandResponder = new ");
            
            #line default
            #line hidden
            
            #line 259 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 259 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 259 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 259 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".CommandResponders.");
            
            #line default
            #line hidden
            
            #line 259 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 259 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("();\r\n                    commandResponder.CommandListHandle = ");
            
            #line default
            #line hidden
            
            #line 260 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 260 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 260 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 260 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 260 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 260 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("ResponderProvider.Allocate(World);\r\n                    commandResponder.Response" +
                    "sToSend = new List<");
            
            #line default
            #line hidden
            
            #line 261 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 261 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 261 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 261 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 261 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 261 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Response>();\r\n\r\n                    entityManager.AddComponentData(entity, comma" +
                    "ndResponder);\r\n                }\r\n");
            
            #line default
            #line hidden
            
            #line 265 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 266 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"            }

            private void ApplyAuthorityChange(Unity.Entities.Entity entity, Authority authority, global::Improbable.Worker.EntityId entityId)
            {
                switch (authority)
                {
                    case Authority.Authoritative:
                        if (!entityManager.HasComponent<NotAuthoritative<");
            
            #line default
            #line hidden
            
            #line 273 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 273 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@">>(entity))
                        {
                            LogInvalidAuthorityTransition(Authority.Authoritative, Authority.NotAuthoritative, entityId);
                            return;
                        }

                        entityManager.RemoveComponent<NotAuthoritative<");
            
            #line default
            #line hidden
            
            #line 279 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 279 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">>(entity);\r\n                        entityManager.AddComponentData(entity, new A" +
                    "uthoritative<");
            
            #line default
            #line hidden
            
            #line 280 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 280 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">());\r\n\r\n                        // Add event senders\r\n");
            
            #line default
            #line hidden
            
            #line 283 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetail in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 284 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                        {\r\n                            var eventSender = new Even" +
                    "tSender.");
            
            #line default
            #line hidden
            
            #line 285 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 285 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("()\r\n                            {\r\n                                handle = Refer" +
                    "enceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 287 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 287 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Provider.Allocate(World)\r\n                            };\r\n                       " +
                    "     ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 289 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 289 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Provider.Set(eventSender.handle, new List<");
            
            #line default
            #line hidden
            
            #line 289 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.FullyQualifiedPayloadTypeName ));
            
            #line default
            #line hidden
            
            #line 289 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">());\r\n                            entityManager.AddComponentData(entity, eventSe" +
                    "nder);\r\n                        }\r\n");
            
            #line default
            #line hidden
            
            #line 292 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 293 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                        break;\r\n                    case Authority.AuthorityLossI" +
                    "mminent:\r\n                        if (!entityManager.HasComponent<Authoritative<" +
                    "");
            
            #line default
            #line hidden
            
            #line 295 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 295 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@">>(entity))
                        {
                            LogInvalidAuthorityTransition(Authority.AuthorityLossImminent, Authority.Authoritative, entityId);
                            return;
                        }

                        entityManager.AddComponentData(entity, new AuthorityLossImminent<");
            
            #line default
            #line hidden
            
            #line 301 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 301 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">());\r\n                        break;\r\n                    case Authority.NotAuth" +
                    "oritative:\r\n                        if (!entityManager.HasComponent<Authoritativ" +
                    "e<");
            
            #line default
            #line hidden
            
            #line 304 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 304 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@">>(entity))
                        {
                            LogInvalidAuthorityTransition(Authority.NotAuthoritative, Authority.Authoritative, entityId);
                            return;
                        }

                        if (entityManager.HasComponent<AuthorityLossImminent<");
            
            #line default
            #line hidden
            
            #line 310 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 310 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">>(entity))\r\n                        {\r\n                            entityManager" +
                    ".RemoveComponent<AuthorityLossImminent<");
            
            #line default
            #line hidden
            
            #line 312 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 312 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">>(entity);\r\n                        }\r\n\r\n                        entityManager.R" +
                    "emoveComponent<Authoritative<");
            
            #line default
            #line hidden
            
            #line 315 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 315 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">>(entity);\r\n                        entityManager.AddComponentData(entity, new N" +
                    "otAuthoritative<");
            
            #line default
            #line hidden
            
            #line 316 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 316 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">());\r\n\r\n                        // Remove event senders\r\n");
            
            #line default
            #line hidden
            
            #line 319 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetail in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 320 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                        {\r\n                            var eventSender = entityMa" +
                    "nager.GetComponentData<EventSender.");
            
            #line default
            #line hidden
            
            #line 321 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 321 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entity);\r\n                            ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 322 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 322 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Provider.Free(eventSender.handle);\r\n                            entityManager.Rem" +
                    "oveComponent<EventSender.");
            
            #line default
            #line hidden
            
            #line 323 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 323 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entity);\r\n                        }\r\n");
            
            #line default
            #line hidden
            
            #line 325 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 326 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                        break;\r\n                }\r\n\r\n                if (entityMa" +
                    "nager.HasComponent<AuthorityChanges<");
            
            #line default
            #line hidden
            
            #line 329 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 329 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">>(entity))\r\n                {\r\n                    var changes = entityManager.G" +
                    "etComponentData<AuthorityChanges<");
            
            #line default
            #line hidden
            
            #line 331 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 331 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">>(entity);\r\n                    changes.Changes.Add(authority);\r\n               " +
                    " }\r\n                else\r\n                {\r\n                    var changes = n" +
                    "ew AuthorityChanges<");
            
            #line default
            #line hidden
            
            #line 336 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 336 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@">
                    {
                        Handle = AuthorityChangesProvider.Allocate(World)
                    };
                    AuthorityChangesProvider.Set(changes.Handle, new List<Authority>());
                    entityManager.AddComponentData(entity, changes);
                }
            }

            private bool IsValidEntityId(global::Improbable.Worker.EntityId entityId, string opType, out Unity.Entities.Entity entity)
            {
                if (!MutableView.TryGetEntity(entityId, out entity))
                {
                    LogDispatcher.HandleLog(LogType.Error, new LogEvent(EntityNotFound)
                        .WithField(LoggingUtils.LoggerName, LoggerName)
                        .WithField(LoggingUtils.EntityId, entityId.Id)
                        .WithField(""Op"", opType)
                        .WithField(""Component"", """);
            
            #line default
            #line hidden
            
            #line 353 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 353 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@""")
                    );
                    return false;
                }

                return true;
            }

            private void LogInvalidAuthorityTransition(Authority newAuthority, Authority expectedOldAuthority, global::Improbable.Worker.EntityId entityId)
            {
                LogDispatcher.HandleLog(LogType.Error, new LogEvent(InvalidAuthorityChange)
                    .WithField(LoggingUtils.LoggerName, LoggerName)
                    .WithField(LoggingUtils.EntityId, entityId.Id)
                    .WithField(""New Authority"", newAuthority)
                    .WithField(""Expected Old Authority"", expectedOldAuthority)
                    .WithField(""Component"", """);
            
            #line default
            #line hidden
            
            #line 368 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 368 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\")\r\n                );\r\n            }\r\n\r\n");
            
            #line default
            #line hidden
            
            #line 372 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var commandDetails in commandDetailsList) {
    var wrappedCommandRequestType = $"{qualifiedNamespace}.{componentDetails.ComponentName}.{commandDetails.CommandName}.ReceivedRequest";
    var commandRequestBufferType = $"{qualifiedNamespace}.{componentDetails.ComponentName}.CommandRequests.{commandDetails.CommandName}";

    var wrappedCommandResponseType = $"{qualifiedNamespace}.{componentDetails.ComponentName}.{commandDetails.CommandName}.ReceivedResponse";
    var commandResponseBufferType = $"{qualifiedNamespace}.{componentDetails.ComponentName}.CommandResponses.{commandDetails.CommandName}";

    var commandStorage = $"{commandDetails.CamelCaseName}Storage";

            
            #line default
            #line hidden
            
            #line 381 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("            private void On");
            
            #line default
            #line hidden
            
            #line 381 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 381 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Request(CommandRequestOp op)\r\n            {\r\n                if (!IsValidEntityId" +
                    "(op.EntityId, \"CommandRequestOp\", out var entity))\r\n                {\r\n         " +
                    "           return;\r\n                }\r\n\r\n                var deserializedRequest" +
                    " = ");
            
            #line default
            #line hidden
            
            #line 388 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.RequestType ));
            
            #line default
            #line hidden
            
            #line 388 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Serialization.Deserialize(op.Request.SchemaData.Value.GetObject());\r\n\r\n         " +
                    "       List<");
            
            #line default
            #line hidden
            
            #line 390 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( wrappedCommandRequestType ));
            
            #line default
            #line hidden
            
            #line 390 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("> requests;\r\n                if (entityManager.HasComponent<");
            
            #line default
            #line hidden
            
            #line 391 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandRequestBufferType ));
            
            #line default
            #line hidden
            
            #line 391 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entity))\r\n                {\r\n                    requests = entityManager.GetCo" +
                    "mponentData<");
            
            #line default
            #line hidden
            
            #line 393 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandRequestBufferType ));
            
            #line default
            #line hidden
            
            #line 393 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entity).Requests;\r\n                }\r\n                else\r\n                {\r\n" +
                    "                    var data = new ");
            
            #line default
            #line hidden
            
            #line 397 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandRequestBufferType ));
            
            #line default
            #line hidden
            
            #line 397 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                    {\r\n                        CommandListHandle = ");
            
            #line default
            #line hidden
            
            #line 399 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 399 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 399 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 399 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 399 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 399 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("RequestsProvider.Allocate(World)\r\n                    };\r\n                    req" +
                    "uests = data.Requests = new List<");
            
            #line default
            #line hidden
            
            #line 401 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( wrappedCommandRequestType ));
            
            #line default
            #line hidden
            
            #line 401 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">();\r\n                    entityManager.AddComponentData(entity, data);\r\n        " +
                    "        }\r\n\r\n                requests.Add(new ");
            
            #line default
            #line hidden
            
            #line 405 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( wrappedCommandRequestType ));
            
            #line default
            #line hidden
            
            #line 405 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("(op.RequestId.Id,\r\n                    op.CallerWorkerId,\r\n                    op" +
                    ".CallerAttributeSet,\r\n                    deserializedRequest));\r\n            }\r" +
                    "\n\r\n            private void On");
            
            #line default
            #line hidden
            
            #line 411 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 411 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Response(CommandResponseOp op)\r\n            {\r\n                if (!");
            
            #line default
            #line hidden
            
            #line 413 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandStorage ));
            
            #line default
            #line hidden
            
            #line 413 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".CommandRequestsInFlight.TryGetValue(op.RequestId.Id, out var requestBundle))\r\n  " +
                    "              {\r\n                    throw new InvalidOperationException($\"Could" +
                    " not find corresponding request for RequestId {op.RequestId.Id} and command ");
            
            #line default
            #line hidden
            
            #line 415 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 415 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".\");\r\n                }\r\n\r\n                var entity = requestBundle.Entity;\r\n  " +
                    "              ");
            
            #line default
            #line hidden
            
            #line 419 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandStorage ));
            
            #line default
            #line hidden
            
            #line 419 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".CommandRequestsInFlight.Remove(op.RequestId.Id);
                if (!entityManager.Exists(entity))
                {
                    LogDispatcher.HandleLog(LogType.Error, new LogEvent(EntityNotFound)
                        .WithField(LoggingUtils.LoggerName, LoggerName)
                        .WithField(""Op"", ""CommandResponseOp - ");
            
            #line default
            #line hidden
            
            #line 424 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 424 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\")\r\n                        .WithField(\"Component\", \"");
            
            #line default
            #line hidden
            
            #line 425 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 425 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\")\r\n                    );\r\n                    return;\r\n                }\r\n\r\n   " +
                    "             ");
            
            #line default
            #line hidden
            
            #line 430 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.ResponseType ));
            
            #line default
            #line hidden
            
            #line 430 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("? response = null;\r\n                if (op.StatusCode == StatusCode.Success)\r\n   " +
                    "             {\r\n                    response = ");
            
            #line default
            #line hidden
            
            #line 433 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.ResponseType ));
            
            #line default
            #line hidden
            
            #line 433 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Serialization.Deserialize(op.Response.SchemaData.Value.GetObject());\r\n          " +
                    "      }\r\n\r\n                List<");
            
            #line default
            #line hidden
            
            #line 436 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( wrappedCommandResponseType ));
            
            #line default
            #line hidden
            
            #line 436 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("> responses;\r\n                if (entityManager.HasComponent<");
            
            #line default
            #line hidden
            
            #line 437 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandResponseBufferType ));
            
            #line default
            #line hidden
            
            #line 437 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entity))\r\n                {\r\n                    responses = entityManager.GetC" +
                    "omponentData<");
            
            #line default
            #line hidden
            
            #line 439 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandResponseBufferType ));
            
            #line default
            #line hidden
            
            #line 439 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entity).Responses;\r\n                }\r\n                else\r\n                {\r" +
                    "\n                    var data = new ");
            
            #line default
            #line hidden
            
            #line 443 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandResponseBufferType ));
            
            #line default
            #line hidden
            
            #line 443 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                    {\r\n                        CommandListHandle = ");
            
            #line default
            #line hidden
            
            #line 445 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 445 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 445 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 445 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 445 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 445 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("ResponsesProvider.Allocate(World)\r\n                    };\r\n                    re" +
                    "sponses = data.Responses = new List<");
            
            #line default
            #line hidden
            
            #line 447 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( wrappedCommandResponseType ));
            
            #line default
            #line hidden
            
            #line 447 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">();\r\n                    entityManager.AddComponentData(entity, data);\r\n        " +
                    "        }\r\n\r\n                responses.Add(new ");
            
            #line default
            #line hidden
            
            #line 451 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( wrappedCommandResponseType ));
            
            #line default
            #line hidden
            
            #line 451 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("(op.EntityId,\r\n                    op.Message,\r\n                    op.StatusCode" +
                    ",\r\n                    response,\r\n                    requestBundle.Request));\r\n" +
                    "            }\r\n");
            
            #line default
            #line hidden
            
            #line 457 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 458 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("        }\r\n\r\n        public class ComponentReplicator : ComponentReplicationHandl" +
                    "er\r\n        {\r\n            public override uint ComponentId => ");
            
            #line default
            #line hidden
            
            #line 462 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentId ));
            
            #line default
            #line hidden
            
            #line 462 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(";\r\n\r\n            public override ComponentType[] ReplicationComponentTypes => new" +
                    " ComponentType[] {\r\n");
            
            #line default
            #line hidden
            
            #line 465 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetail in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 466 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                ComponentType.ReadOnly<EventSender.");
            
            #line default
            #line hidden
            
            #line 466 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 466 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(),\r\n");
            
            #line default
            #line hidden
            
            #line 467 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 468 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                ComponentType.Create<");
            
            #line default
            #line hidden
            
            #line 468 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 468 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(),\r\n                ComponentType.ReadOnly<Authoritative<");
            
            #line default
            #line hidden
            
            #line 469 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 469 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">>(),\r\n                ComponentType.ReadOnly<SpatialEntityId>()\r\n            };\r" +
                    "\n\r\n            public override ComponentType[] CommandTypes => new ComponentType" +
                    "[] {\r\n");
            
            #line default
            #line hidden
            
            #line 474 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 475 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                ComponentType.ReadOnly<");
            
            #line default
            #line hidden
            
            #line 475 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 475 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 475 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 475 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".CommandSenders.");
            
            #line default
            #line hidden
            
            #line 475 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 475 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(),\r\n                ComponentType.ReadOnly<");
            
            #line default
            #line hidden
            
            #line 476 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 476 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 476 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 476 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".CommandResponders.");
            
            #line default
            #line hidden
            
            #line 476 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 476 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(),\r\n");
            
            #line default
            #line hidden
            
            #line 477 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 478 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("            };\r\n\r\n");
            
            #line default
            #line hidden
            
            #line 480 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 481 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("            private CommandStorages.");
            
            #line default
            #line hidden
            
            #line 481 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName));
            
            #line default
            #line hidden
            
            #line 481 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(" ");
            
            #line default
            #line hidden
            
            #line 481 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseName ));
            
            #line default
            #line hidden
            
            #line 481 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Storage;\r\n");
            
            #line default
            #line hidden
            
            #line 482 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 483 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n            public ComponentReplicator(EntityManager entityManager, Unity.Entit" +
                    "ies.World world) : base(entityManager)\r\n            {\r\n                var bookk" +
                    "eepingSystem = world.GetOrCreateManager<CommandRequestTrackerSystem>();\r\n");
            
            #line default
            #line hidden
            
            #line 487 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 488 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                ");
            
            #line default
            #line hidden
            
            #line 488 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseName ));
            
            #line default
            #line hidden
            
            #line 488 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Storage = bookkeepingSystem.GetCommandStorageForType<CommandStorages.");
            
            #line default
            #line hidden
            
            #line 488 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName));
            
            #line default
            #line hidden
            
            #line 488 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">();\r\n");
            
            #line default
            #line hidden
            
            #line 489 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 490 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"            }

            public override void ExecuteReplication(ComponentGroup replicationGroup, Connection connection)
            {
                var entityIdDataArray = replicationGroup.GetComponentDataArray<SpatialEntityId>();
                var componentDataArray = replicationGroup.GetComponentDataArray<");
            
            #line default
            #line hidden
            
            #line 495 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 495 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">();\r\n");
            
            #line default
            #line hidden
            
            #line 496 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetail in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 497 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                var event");
            
            #line default
            #line hidden
            
            #line 497 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 497 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Array = replicationGroup.GetComponentDataArray<EventSender.");
            
            #line default
            #line hidden
            
            #line 497 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 497 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">();\r\n");
            
            #line default
            #line hidden
            
            #line 498 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 499 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                for (var i = 0; i < componentDataArray.Length; i++)\r\n          " +
                    "      {\r\n                    var data = componentDataArray[i];\r\n                " +
                    "    var dirtyEvents = 0;\r\n");
            
            #line default
            #line hidden
            
            #line 504 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetail in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 505 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                    var events");
            
            #line default
            #line hidden
            
            #line 505 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 505 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(" = event");
            
            #line default
            #line hidden
            
            #line 505 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 505 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Array[i].Events;\r\n                    dirtyEvents += events");
            
            #line default
            #line hidden
            
            #line 506 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 506 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Count;\r\n");
            
            #line default
            #line hidden
            
            #line 507 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 508 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                    if (data.DirtyBit || dirtyEvents > 0)\r\n                    " +
                    "{\r\n                        var update = new global::Improbable.Worker.Core.Schem" +
                    "aComponentUpdate(");
            
            #line default
            #line hidden
            
            #line 511 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentId ));
            
            #line default
            #line hidden
            
            #line 511 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(");\r\n                        ");
            
            #line default
            #line hidden
            
            #line 512 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 512 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Serialization.Serialize(data, update.GetFields());\r\n\r\n");
            
            #line default
            #line hidden
            
            #line 514 "Templates\UnityComponentConversionGenerator.tt"
 if (eventDetailsList.Count > 0) { 
            
            #line default
            #line hidden
            
            #line 515 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                        // Serialize events\r\n                        var eventsOb" +
                    "ject = update.GetEvents();\r\n");
            
            #line default
            #line hidden
            
            #line 517 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetail in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 518 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                        if (events");
            
            #line default
            #line hidden
            
            #line 518 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 518 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Count > 0)\r\n                        {\r\n                            foreach (var " +
                    "e in events");
            
            #line default
            #line hidden
            
            #line 520 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 520 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(")\r\n                            {\r\n                                var obj = event" +
                    "sObject.AddObject(");
            
            #line default
            #line hidden
            
            #line 522 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventIndex ));
            
            #line default
            #line hidden
            
            #line 522 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(");\r\n                                ");
            
            #line default
            #line hidden
            
            #line 523 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.FullyQualifiedPayloadTypeName ));
            
            #line default
            #line hidden
            
            #line 523 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Serialization.Serialize(e, obj);\r\n                            }\r\n\r\n             " +
                    "               events");
            
            #line default
            #line hidden
            
            #line 526 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 526 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Clear();\r\n                        }\r\n\r\n");
            
            #line default
            #line hidden
            
            #line 529 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 530 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 531 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"                        // Send serialized update over the wire
                        connection.SendComponentUpdate(entityIdDataArray[i].EntityId, new global::Improbable.Worker.Core.ComponentUpdate(update));

                        data.DirtyBit = false;
                        componentDataArray[i] = data;
                    }
                }
            }

            public override void SendCommands(List<ComponentGroup> commandComponentGroups, Connection connection)
            {
");
            
            #line default
            #line hidden
            
            #line 542 "Templates\UnityComponentConversionGenerator.tt"

for (var i = 0; i < commandDetailsList.Count; i++) {
    var commandDetails = commandDetailsList[i];
    var commandSenderType = $"{qualifiedNamespace}.{componentDetails.ComponentName}.CommandSenders.{commandDetails.CommandName}";
    var commandResponderType = $"{qualifiedNamespace}.{componentDetails.ComponentName}.CommandResponders.{commandDetails.CommandName}";

            
            #line default
            #line hidden
            
            #line 548 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                if (!commandComponentGroups[");
            
            #line default
            #line hidden
            
            #line 548 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( 2*i ));
            
            #line default
            #line hidden
            
            #line 548 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("].IsEmptyIgnoreFilter)\r\n                {\r\n                    var componentGroup" +
                    " = commandComponentGroups[");
            
            #line default
            #line hidden
            
            #line 550 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( 2*i ));
            
            #line default
            #line hidden
            
            #line 550 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("];\r\n                    var commandSenderDataArray = componentGroup.GetComponentD" +
                    "ataArray<");
            
            #line default
            #line hidden
            
            #line 551 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandSenderType ));
            
            #line default
            #line hidden
            
            #line 551 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@">();
                    var entityArray = componentGroup.GetEntityArray();

                    for (var j = 0; j < commandSenderDataArray.Length; j++)
                    {
                        var requests = commandSenderDataArray[j];
                        for (var k = 0; k < requests.RequestsToSend.Count; k++)
                        {
                            var wrappedCommandRequest = requests.RequestsToSend[k];

                            var schemaCommandRequest = new global::Improbable.Worker.Core.SchemaCommandRequest(ComponentId, ");
            
            #line default
            #line hidden
            
            #line 561 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandIndex ));
            
            #line default
            #line hidden
            
            #line 561 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(");\r\n                            ");
            
            #line default
            #line hidden
            
            #line 562 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.RequestType ));
            
            #line default
            #line hidden
            
            #line 562 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".Serialization.Serialize(wrappedCommandRequest.RawRequest, schemaCommandRequest.GetObject());

                            var requestId = connection.SendCommandRequest(wrappedCommandRequest.TargetEntityId,
                                new global::Improbable.Worker.Core.CommandRequest(schemaCommandRequest),
                                wrappedCommandRequest.TimeoutMillis,
                                wrappedCommandRequest.AllowShortCircuiting ? ShortCircuitParameters : null);

                            ");
            
            #line default
            #line hidden
            
            #line 569 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseName ));
            
            #line default
            #line hidden
            
            #line 569 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Storage.CommandRequestsInFlight[requestId.Id] =\r\n                                " +
                    "new CommandRequestStore<");
            
            #line default
            #line hidden
            
            #line 570 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.RequestType ));
            
            #line default
            #line hidden
            
            #line 570 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entityArray[j], wrappedCommandRequest.RawRequest, null);\r\n                     " +
                    "   }\r\n\r\n                        requests.RequestsToSend.Clear();\r\n              " +
                    "      }\r\n                }\r\n                if (!commandComponentGroups[");
            
            #line default
            #line hidden
            
            #line 576 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( 2*i + 1 ));
            
            #line default
            #line hidden
            
            #line 576 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("].IsEmptyIgnoreFilter)\r\n                {\r\n                    var componentGroup" +
                    " = commandComponentGroups[");
            
            #line default
            #line hidden
            
            #line 578 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( 2*i + 1 ));
            
            #line default
            #line hidden
            
            #line 578 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("];\r\n                    var commandResponderDataArray = componentGroup.GetCompone" +
                    "ntDataArray<");
            
            #line default
            #line hidden
            
            #line 579 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandResponderType ));
            
            #line default
            #line hidden
            
            #line 579 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@">();

                    for (var j = 0; j < commandResponderDataArray.Length; j++)
                    {
                        var responses = commandResponderDataArray[j];
                        for (var k = 0; k < responses.ResponsesToSend.Count; k++)
                        {
                            var wrappedCommandResponse = responses.ResponsesToSend[k];
                            var requestId = new global::Improbable.Worker.Core.RequestId<IncomingCommandRequest>(wrappedCommandResponse.RequestId);

                            if (wrappedCommandResponse.FailureMessage != null)
                            {
                                // Send a command failure if the string is non-null.
                                connection.SendCommandFailure(requestId, wrappedCommandResponse.FailureMessage);
                                continue;
                            }

                            var schemaCommandResponse = new global::Improbable.Worker.Core.SchemaCommandResponse(ComponentId, ");
            
            #line default
            #line hidden
            
            #line 596 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandIndex ));
            
            #line default
            #line hidden
            
            #line 596 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(");\r\n                            ");
            
            #line default
            #line hidden
            
            #line 597 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.ResponseType ));
            
            #line default
            #line hidden
            
            #line 597 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".Serialization.Serialize(wrappedCommandResponse.RawResponse.Value, schemaCommandResponse.GetObject());

                            connection.SendCommandResponse(requestId, new global::Improbable.Worker.Core.CommandResponse(schemaCommandResponse));
                        }

                        responses.ResponsesToSend.Clear();
                    }
                }
");
            
            #line default
            #line hidden
            
            #line 605 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 606 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("            }\r\n\r\n        }\r\n\r\n        public class ComponentCleanup : ComponentCl" +
                    "eanupHandler\r\n        {\r\n            public override ComponentType[] CleanUpComp" +
                    "onentTypes => new ComponentType[] {\r\n                typeof(ComponentAdded<");
            
            #line default
            #line hidden
            
            #line 613 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 613 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">),\r\n                typeof(ComponentRemoved<");
            
            #line default
            #line hidden
            
            #line 614 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 614 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">),\r\n            };\r\n\r\n            public override ComponentType[] EventComponent" +
                    "Types => new ComponentType[] {\r\n");
            
            #line default
            #line hidden
            
            #line 618 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetails in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 619 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                typeof(ReceivedEvents.");
            
            #line default
            #line hidden
            
            #line 619 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventName ));
            
            #line default
            #line hidden
            
            #line 619 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("),\r\n");
            
            #line default
            #line hidden
            
            #line 620 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 621 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("            };\r\n\r\n            public override ComponentType ComponentUpdateType =" +
                    "> ComponentType.ReadOnly<");
            
            #line default
            #line hidden
            
            #line 623 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 623 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReceivedUpdates>();\r\n            public override ComponentType AuthorityChangesT" +
                    "ype => ComponentType.ReadOnly<AuthorityChanges<");
            
            #line default
            #line hidden
            
            #line 624 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 624 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">>();\r\n\r\n            public override ComponentType[] CommandReactiveTypes => new " +
                    "ComponentType[] {\r\n");
            
            #line default
            #line hidden
            
            #line 627 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 628 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                ComponentType.ReadOnly<CommandRequests.");
            
            #line default
            #line hidden
            
            #line 628 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 628 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(),\r\n                ComponentType.ReadOnly<CommandResponses.");
            
            #line default
            #line hidden
            
            #line 629 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 629 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(),\r\n");
            
            #line default
            #line hidden
            
            #line 630 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 631 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"            };

            public override void CleanupUpdates(ComponentGroup updateGroup, ref EntityCommandBuffer buffer)
            {
                var entities = updateGroup.GetEntityArray();
                var data = updateGroup.GetComponentDataArray<");
            
            #line default
            #line hidden
            
            #line 636 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 636 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReceivedUpdates>();\r\n                for (var i = 0; i < entities.Length; i++)\r\n" +
                    "                {\r\n                    buffer.RemoveComponent<");
            
            #line default
            #line hidden
            
            #line 639 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 639 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".ReceivedUpdates>(entities[i]);
                    ReferenceTypeProviders.UpdatesProvider.Free(data[i].handle);
                }
            }

            public override void CleanupAuthChanges(ComponentGroup authorityChangeGroup, ref EntityCommandBuffer buffer)
            {
                var entities = authorityChangeGroup.GetEntityArray();
                var data = authorityChangeGroup.GetComponentDataArray<AuthorityChanges<");
            
            #line default
            #line hidden
            
            #line 647 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 647 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">>();\r\n                for (var i = 0; i < entities.Length; i++)\r\n               " +
                    " {\r\n                    buffer.RemoveComponent<AuthorityChanges<");
            
            #line default
            #line hidden
            
            #line 650 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.TypeName ));
            
            #line default
            #line hidden
            
            #line 650 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">>(entities[i]);\r\n                    AuthorityChangesProvider.Free(data[i].Handl" +
                    "e);\r\n                }\r\n            }\r\n\r\n            public override void Cleanu" +
                    "pEvents(ComponentGroup[] eventGroups, ref EntityCommandBuffer buffer)\r\n         " +
                    "   {\r\n");
            
            #line default
            #line hidden
            
            #line 657 "Templates\UnityComponentConversionGenerator.tt"
 for (var i = 0; i < eventDetailsList.Count; i++) { 
            
            #line default
            #line hidden
            
            #line 658 "Templates\UnityComponentConversionGenerator.tt"
 var eventDetails = eventDetailsList[i]; 
            
            #line default
            #line hidden
            
            #line 659 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                // Clean ");
            
            #line default
            #line hidden
            
            #line 659 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventName ));
            
            #line default
            #line hidden
            
            #line 659 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                {\r\n                    var group = eventGroups[");
            
            #line default
            #line hidden
            
            #line 661 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( i ));
            
            #line default
            #line hidden
            
            #line 661 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("];\r\n                    if (!group.IsEmptyIgnoreFilter)\r\n                    {\r\n " +
                    "                       var entities = group.GetEntityArray();\r\n                 " +
                    "       var data = group.GetComponentDataArray<ReceivedEvents.");
            
            #line default
            #line hidden
            
            #line 665 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventName ));
            
            #line default
            #line hidden
            
            #line 665 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">();\r\n                        for (var i = 0; i < entities.Length; i++)\r\n        " +
                    "                {\r\n                            buffer.RemoveComponent<ReceivedEv" +
                    "ents.");
            
            #line default
            #line hidden
            
            #line 668 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventName ));
            
            #line default
            #line hidden
            
            #line 668 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entities[i]);\r\n                            ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 669 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventName ));
            
            #line default
            #line hidden
            
            #line 669 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Provider.Free(data[i].handle);\r\n                        }\r\n                    }\r" +
                    "\n                }\r\n");
            
            #line default
            #line hidden
            
            #line 673 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 674 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("            }\r\n\r\n            public override void CleanupCommands(ComponentGroup[" +
                    "] commandCleanupGroups, ref EntityCommandBuffer buffer)\r\n            {\r\n");
            
            #line default
            #line hidden
            
            #line 678 "Templates\UnityComponentConversionGenerator.tt"

for (var j = 0; j < commandDetailsList.Count; j++) {
    var commandDetails = commandDetailsList[j];

            
            #line default
            #line hidden
            
            #line 682 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                if (!commandCleanupGroups[");
            
            #line default
            #line hidden
            
            #line 682 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( 2*j ));
            
            #line default
            #line hidden
            
            #line 682 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("].IsEmptyIgnoreFilter)\r\n                {\r\n                    var requestsGroup " +
                    "= commandCleanupGroups[");
            
            #line default
            #line hidden
            
            #line 684 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( 2*j ));
            
            #line default
            #line hidden
            
            #line 684 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("];\r\n                    var entities = requestsGroup.GetEntityArray();\r\n         " +
                    "           var data = requestsGroup.GetComponentDataArray<CommandRequests.");
            
            #line default
            #line hidden
            
            #line 686 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 686 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">();\r\n                    for (var i = 0; i < entities.Length; i++)\r\n            " +
                    "        {\r\n                        buffer.RemoveComponent<CommandRequests.");
            
            #line default
            #line hidden
            
            #line 689 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 689 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entities[i]);\r\n                        ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 690 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 690 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("RequestsProvider.Free(data[i].CommandListHandle);\r\n                    }\r\n       " +
                    "         }\r\n\r\n                if (!commandCleanupGroups[");
            
            #line default
            #line hidden
            
            #line 694 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( 2*j + 1 ));
            
            #line default
            #line hidden
            
            #line 694 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("].IsEmptyIgnoreFilter)\r\n                {\r\n                    var responsesGroup" +
                    " = commandCleanupGroups[");
            
            #line default
            #line hidden
            
            #line 696 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( 2*j + 1 ));
            
            #line default
            #line hidden
            
            #line 696 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("];\r\n                    var entities = responsesGroup.GetEntityArray();\r\n        " +
                    "            var data = responsesGroup.GetComponentDataArray<CommandResponses.");
            
            #line default
            #line hidden
            
            #line 698 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 698 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">();\r\n                    for (var i = 0; i < entities.Length; i++)\r\n            " +
                    "        {\r\n                        buffer.RemoveComponent<CommandResponses.");
            
            #line default
            #line hidden
            
            #line 701 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 701 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entities[i]);\r\n                        ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 702 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 702 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("ResponsesProvider.Free(data[i].CommandListHandle);\r\n                    }\r\n      " +
                    "          }\r\n");
            
            #line default
            #line hidden
            
            #line 705 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 706 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("            }\r\n        }\r\n    }\r\n\r\n}\r\n");
            
            #line default
            #line hidden
            return this.GenerationEnvironment.ToString();
        }
        
        public virtual void Initialize() {
        }
    }
    
    public class UnityComponentConversionGeneratorBase {
        
        private global::System.Text.StringBuilder builder;
        
        private global::System.Collections.Generic.IDictionary<string, object> session;
        
        private global::System.CodeDom.Compiler.CompilerErrorCollection errors;
        
        private string currentIndent = string.Empty;
        
        private global::System.Collections.Generic.Stack<int> indents;
        
        private ToStringInstanceHelper _toStringHelper = new ToStringInstanceHelper();
        
        public virtual global::System.Collections.Generic.IDictionary<string, object> Session {
            get {
                return this.session;
            }
            set {
                this.session = value;
            }
        }
        
        public global::System.Text.StringBuilder GenerationEnvironment {
            get {
                if ((this.builder == null)) {
                    this.builder = new global::System.Text.StringBuilder();
                }
                return this.builder;
            }
            set {
                this.builder = value;
            }
        }
        
        protected global::System.CodeDom.Compiler.CompilerErrorCollection Errors {
            get {
                if ((this.errors == null)) {
                    this.errors = new global::System.CodeDom.Compiler.CompilerErrorCollection();
                }
                return this.errors;
            }
        }
        
        public string CurrentIndent {
            get {
                return this.currentIndent;
            }
        }
        
        private global::System.Collections.Generic.Stack<int> Indents {
            get {
                if ((this.indents == null)) {
                    this.indents = new global::System.Collections.Generic.Stack<int>();
                }
                return this.indents;
            }
        }
        
        public ToStringInstanceHelper ToStringHelper {
            get {
                return this._toStringHelper;
            }
        }
        
        public void Error(string message) {
            this.Errors.Add(new global::System.CodeDom.Compiler.CompilerError(null, -1, -1, null, message));
        }
        
        public void Warning(string message) {
            global::System.CodeDom.Compiler.CompilerError val = new global::System.CodeDom.Compiler.CompilerError(null, -1, -1, null, message);
            val.IsWarning = true;
            this.Errors.Add(val);
        }
        
        public string PopIndent() {
            if ((this.Indents.Count == 0)) {
                return string.Empty;
            }
            int lastPos = (this.currentIndent.Length - this.Indents.Pop());
            string last = this.currentIndent.Substring(lastPos);
            this.currentIndent = this.currentIndent.Substring(0, lastPos);
            return last;
        }
        
        public void PushIndent(string indent) {
            this.Indents.Push(indent.Length);
            this.currentIndent = (this.currentIndent + indent);
        }
        
        public void ClearIndent() {
            this.currentIndent = string.Empty;
            this.Indents.Clear();
        }
        
        public void Write(string textToAppend) {
            this.GenerationEnvironment.Append(textToAppend);
        }
        
        public void Write(string format, params object[] args) {
            this.GenerationEnvironment.AppendFormat(format, args);
        }
        
        public void WriteLine(string textToAppend) {
            this.GenerationEnvironment.Append(this.currentIndent);
            this.GenerationEnvironment.AppendLine(textToAppend);
        }
        
        public void WriteLine(string format, params object[] args) {
            this.GenerationEnvironment.Append(this.currentIndent);
            this.GenerationEnvironment.AppendFormat(format, args);
            this.GenerationEnvironment.AppendLine();
        }
        
        public class ToStringInstanceHelper {
            
            private global::System.IFormatProvider formatProvider = global::System.Globalization.CultureInfo.InvariantCulture;
            
            public global::System.IFormatProvider FormatProvider {
                get {
                    return this.formatProvider;
                }
                set {
                    if ((value != null)) {
                        this.formatProvider = value;
                    }
                }
            }
            
            public string ToStringWithCulture(object objectToConvert) {
                if ((objectToConvert == null)) {
                    throw new global::System.ArgumentNullException("objectToConvert");
                }
                global::System.Type type = objectToConvert.GetType();
                global::System.Type iConvertibleType = typeof(global::System.IConvertible);
                if (iConvertibleType.IsAssignableFrom(type)) {
                    return ((global::System.IConvertible)(objectToConvert)).ToString(this.formatProvider);
                }
                global::System.Reflection.MethodInfo methInfo = type.GetMethod("ToString", new global::System.Type[] {
                            iConvertibleType});
                if ((methInfo != null)) {
                    return ((string)(methInfo.Invoke(objectToConvert, new object[] {
                                this.formatProvider})));
                }
                return objectToConvert.ToString();
            }
        }
    }
}
